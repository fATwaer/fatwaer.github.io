<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title class="pjax-title">ElasticSearch 检索内部原理 - pokpok的研究日志</title><meta name="Description" content="pokpok的研究日志"><meta property="og:title" content="ElasticSearch 检索内部原理" />
<meta property="og:description" content="包括 Elasticsearch 的CRUD和基础检索方式" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/elasticsearch-%E6%A3%80%E7%B4%A2%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86/" /><meta property="og:image" content="/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-24T22:37:19+08:00" />
<meta property="article:modified_time" content="2021-07-24T22:37:19+08:00" /><meta property="og:site_name" content="PokPok的研究日志" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="/logo.png"/>

<meta name="twitter:title" content="ElasticSearch 检索内部原理"/>
<meta name="twitter:description" content="包括 Elasticsearch 的CRUD和基础检索方式"/>
<meta name="application-name" content="DoIt">
<meta name="apple-mobile-web-app-title" content="DoIt">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="/elasticsearch-%E6%A3%80%E7%B4%A2%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86/" /><link rel="prev" href="/elasticsearch-%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/" /><link rel="next" href="/leetcode_dp/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/fontawesome-free/all.min.css">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/animate/animate.min.css">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "ElasticSearch 检索内部原理",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "\/elasticsearch-%E6%A3%80%E7%B4%A2%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86\/"
        },"image": ["https:\/\/blog-1256435232.cos.ap-shanghai.myqcloud.com\/cnblog\/"],"genre": "posts","wordcount":  5241 ,
        "url": "\/elasticsearch-%E6%A3%80%E7%B4%A2%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86\/","datePublished": "2021-07-24T22:37:19+08:00","dateModified": "2021-07-24T22:37:19+08:00","publisher": {
            "@type": "Organization",
            "name": "北极乌布"},"author": {
                "@type": "Person",
                "name": "北极乌布"
            },"description": ""
    }
    </script></head>

<body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme);}
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' || theme === 'black' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('light' === 'light' || 'light' === 'dark' || 'light' === 'black') setTheme('light'), saveTheme('light'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627','black': '#000000'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="pokpok的研究日志"><span id="desktop-header-typeit" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="#" onclick="return false;" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" onclick="return false;" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="#" onclick="return false;" class="menu-item theme-select" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                    <select class="color-theme-select" id="theme-select-desktop" title="切换主题">
                        <option value="light">浅色</option>
                        <option value="dark">深色</option>
                        <option value="black">黑色</option>
                        <option value="auto">跟随系统</option>
                    </select>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="pokpok的研究日志"><span id="mobile-header-typeit" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="#" onclick="return false;" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" onclick="return false;" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="#" onclick="return false;" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/categories/" title="">分类</a><a href="#" onclick="return false;" class="menu-item theme-select" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
                <select class="color-theme-select" id="theme-select-mobile" title="切换主题">
                    <option value="light">浅色</option>
                    <option value="dark">深色</option>
                    <option value="black">黑色</option>
                    <option value="auto">跟随系统</option>
                </select>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">目录</h2>
        <div class="toc-content always-active" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#相关性计算">相关性计算</a>
      <ul>
        <li><a href="#计算">计算</a></li>
      </ul>
    </li>
    <li><a href="#es-分片如何索引文档">ES 分片如何索引文档</a>
      <ul>
        <li><a href="#es-倒排索引的特性">ES 倒排索引的特性</a></li>
        <li><a href="#索引更新流程">索引更新流程</a></li>
        <li><a href="#实时搜索的保证">实时搜索的保证</a></li>
        <li><a href="#文件系统页缓存">文件系统页缓存</a></li>
        <li><a href="#实时删除">实时删除</a></li>
        <li><a href="#持久化">持久化</a></li>
        <li><a href="#段合并">段合并</a></li>
        <li><a href="#总结">总结</a></li>
      </ul>
    </li>
    <li><a href="#分布式检索">分布式检索</a></li>
    <li><a href="#单结点es集群">单结点es集群</a>
      <ul>
        <li><a href="#多节点集群">多节点集群</a></li>
        <li><a href="#多节点负载">多节点负载</a></li>
        <li><a href="#继续扩容">继续扩容</a></li>
        <li><a href="#集群搜索流程">集群搜索流程</a></li>
        <li><a href="#分页集群搜索流程">分页集群搜索流程</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle", "normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">ElasticSearch 检索内部原理</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><i class="author fas fa-user-circle fa-fw"></i><a href="/" title="Author" rel=" author" class="author">北极乌布</a>
                </span>&nbsp;<span class="post-category">收录于 </span>&nbsp;<span class="post-category">类别 <a href="/categories/notes/"><i class="far fa-folder fa-fw"></i>notes</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-07-24">2021-07-24</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime="2021-07-24">2021-07-24</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 5241 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 11 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#相关性计算">相关性计算</a>
      <ul>
        <li><a href="#计算">计算</a></li>
      </ul>
    </li>
    <li><a href="#es-分片如何索引文档">ES 分片如何索引文档</a>
      <ul>
        <li><a href="#es-倒排索引的特性">ES 倒排索引的特性</a></li>
        <li><a href="#索引更新流程">索引更新流程</a></li>
        <li><a href="#实时搜索的保证">实时搜索的保证</a></li>
        <li><a href="#文件系统页缓存">文件系统页缓存</a></li>
        <li><a href="#实时删除">实时删除</a></li>
        <li><a href="#持久化">持久化</a></li>
        <li><a href="#段合并">段合并</a></li>
        <li><a href="#总结">总结</a></li>
      </ul>
    </li>
    <li><a href="#分布式检索">分布式检索</a></li>
    <li><a href="#单结点es集群">单结点es集群</a>
      <ul>
        <li><a href="#多节点集群">多节点集群</a></li>
        <li><a href="#多节点负载">多节点负载</a></li>
        <li><a href="#继续扩容">继续扩容</a></li>
        <li><a href="#集群搜索流程">集群搜索流程</a></li>
        <li><a href="#分页集群搜索流程">分页集群搜索流程</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="相关性计算" class="headerLink">
    <a href="#%e7%9b%b8%e5%85%b3%e6%80%a7%e8%ae%a1%e7%ae%97" class="header-mark"></a>相关性计算</h2><p>首先通过下面的更新语句，插入几条语句：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="err">PUT</span> <span class="err">/megacorp/employee/</span><span class="mi">1</span>
<span class="p">{</span>
    <span class="nt">&#34;first_name&#34;</span> <span class="p">:</span> <span class="s2">&#34;John&#34;</span><span class="p">,</span>
    <span class="nt">&#34;last_name&#34;</span> <span class="p">:</span>  <span class="s2">&#34;Smith&#34;</span><span class="p">,</span>
    <span class="nt">&#34;age&#34;</span> <span class="p">:</span>        <span class="mi">25</span><span class="p">,</span>
    <span class="nt">&#34;about&#34;</span> <span class="p">:</span>      <span class="s2">&#34;I love to go rock climbing&#34;</span><span class="p">,</span>
    <span class="nt">&#34;interests&#34;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&#34;sports&#34;</span><span class="p">,</span> <span class="s2">&#34;music&#34;</span> <span class="p">]</span>
<span class="p">}</span>
<span class="err">PUT</span> <span class="err">/megacorp/employee/</span><span class="mi">2</span>
<span class="p">{</span>
    <span class="nt">&#34;first_name&#34;</span> <span class="p">:</span>  <span class="s2">&#34;Jane&#34;</span><span class="p">,</span>
    <span class="nt">&#34;last_name&#34;</span> <span class="p">:</span>   <span class="s2">&#34;Smith&#34;</span><span class="p">,</span>
    <span class="nt">&#34;age&#34;</span> <span class="p">:</span>         <span class="mi">32</span><span class="p">,</span>
    <span class="nt">&#34;about&#34;</span> <span class="p">:</span>       <span class="s2">&#34;I like to collect rock albums&#34;</span><span class="p">,</span>
    <span class="nt">&#34;interests&#34;</span><span class="p">:</span>  <span class="p">[</span> <span class="s2">&#34;music&#34;</span> <span class="p">]</span>
<span class="p">}</span>
<span class="err">PUT</span> <span class="err">/megacorp/employee/</span><span class="mi">3</span>
<span class="p">{</span>
    <span class="nt">&#34;first_name&#34;</span> <span class="p">:</span>  <span class="s2">&#34;Douglas&#34;</span><span class="p">,</span>
    <span class="nt">&#34;last_name&#34;</span> <span class="p">:</span>   <span class="s2">&#34;Fir&#34;</span><span class="p">,</span>
    <span class="nt">&#34;age&#34;</span> <span class="p">:</span>         <span class="mi">35</span><span class="p">,</span>
    <span class="nt">&#34;about&#34;</span><span class="p">:</span>        <span class="s2">&#34;I like to build cabinets&#34;</span><span class="p">,</span>
    <span class="nt">&#34;interests&#34;</span><span class="p">:</span>  <span class="p">[</span> <span class="s2">&#34;forestry&#34;</span> <span class="p">]</span>
<span class="p">}</span>
</code></pre></div><p>索引中目前一共三个文档：</p>
<ol>
<li>“I love to go rock climbing”</li>
<li>“I like to build cabinets”</li>
<li>“I like to collect rock albums”</li>
</ol>
<p>如果使用下面下面的查询语句：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="err">GET</span> <span class="err">/megacorp/_search</span>
<span class="p">{</span>
    <span class="nt">&#34;query&#34;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;match&#34;</span> <span class="p">:</span> <span class="p">{</span>
           <span class="nt">&#34;about&#34;</span> <span class="p">:</span> <span class="s2">&#34;rock climbing&#34;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&#34;explain&#34;</span> <span class="p">:</span> <span class="kc">true</span>
<span class="p">}</span>
</code></pre></div><p>在 <code>_search</code> 的时候加上 explain 选项就能在结果中输出相关性计算解释。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="s2">&#34;_explanation&#34;</span> <span class="err">:</span> <span class="p">{</span>
      <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mf">1.4167401</span><span class="p">,</span>
      <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;sum of:&#34;</span><span class="p">,</span>
      <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mf">0.4589591</span><span class="p">,</span>
          <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;weight(about:rock in 0) [PerFieldSimilarity], result of:&#34;</span><span class="p">,</span>
          <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mf">0.4589591</span><span class="p">,</span>
              <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;score(freq=1.0), computed as boost * idf * tf from:&#34;</span><span class="p">,</span>
              <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mf">2.2</span><span class="p">,</span>
                  <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;boost&#34;</span><span class="p">,</span>
                  <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">]</span>
                <span class="p">},</span>
                <span class="p">{</span>
                  <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mf">0.47000363</span><span class="p">,</span>
                  <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:&#34;</span><span class="p">,</span>
                  <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                      <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                      <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;n, number of documents containing term&#34;</span><span class="p">,</span>
                      <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">]</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                      <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                      <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;N, total number of documents with field&#34;</span><span class="p">,</span>
                      <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">]</span>
                    <span class="p">}</span>
                  <span class="p">]</span>
                <span class="p">},</span>
                <span class="p">{</span>
                  <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mf">0.44386417</span><span class="p">,</span>
                  <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;tf, computed as freq / (freq + k1 * (1 - b + b * dl / avgdl)) from:&#34;</span><span class="p">,</span>
                  <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                      <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                      <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;freq, occurrences of term within document&#34;</span><span class="p">,</span>
                      <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">]</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                      <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span>
                      <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;k1, term saturation parameter&#34;</span><span class="p">,</span>
                      <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">]</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                      <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mf">0.75</span><span class="p">,</span>
                      <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;b, length normalization parameter&#34;</span><span class="p">,</span>
                      <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">]</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                      <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mf">6.0</span><span class="p">,</span>
                      <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;dl, length of field&#34;</span><span class="p">,</span>
                      <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">]</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                      <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mf">5.6666665</span><span class="p">,</span>
                      <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;avgdl, average length of field&#34;</span><span class="p">,</span>
                      <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">]</span>
                    <span class="p">}</span>
                  <span class="p">]</span>
                <span class="p">}</span>
              <span class="p">]</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mf">0.95778096</span><span class="p">,</span>
          <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;weight(about:climbing in 0) [PerFieldSimilarity], result of:&#34;</span><span class="p">,</span>
          <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mf">0.95778096</span><span class="p">,</span>
              <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;score(freq=1.0), computed as boost * idf * tf from:&#34;</span><span class="p">,</span>
              <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mf">2.2</span><span class="p">,</span>
                  <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;boost&#34;</span><span class="p">,</span>
                  <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">]</span>
                <span class="p">},</span>
                <span class="p">{</span>
                  <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mf">0.98082924</span><span class="p">,</span>
                  <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:&#34;</span><span class="p">,</span>
                  <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                      <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;n, number of documents containing term&#34;</span><span class="p">,</span>
                      <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">]</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                      <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                      <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;N, total number of documents with field&#34;</span><span class="p">,</span>
                      <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">]</span>
                    <span class="p">}</span>
                  <span class="p">]</span>
                <span class="p">},</span>
                <span class="p">{</span>
                  <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mf">0.44386417</span><span class="p">,</span>
                  <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;tf, computed as freq / (freq + k1 * (1 - b + b * dl / avgdl)) from:&#34;</span><span class="p">,</span>
                  <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                      <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                      <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;freq, occurrences of term within document&#34;</span><span class="p">,</span>
                      <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">]</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                      <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span>
                      <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;k1, term saturation parameter&#34;</span><span class="p">,</span>
                      <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">]</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                      <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mf">0.75</span><span class="p">,</span>
                      <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;b, length normalization parameter&#34;</span><span class="p">,</span>
                      <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">]</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                      <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mf">6.0</span><span class="p">,</span>
                      <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;dl, length of field&#34;</span><span class="p">,</span>
                      <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">]</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                      <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mf">5.6666665</span><span class="p">,</span>
                      <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;avgdl, average length of field&#34;</span><span class="p">,</span>
                      <span class="nt">&#34;details&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">]</span>
                    <span class="p">}</span>
                  <span class="p">]</span>
                <span class="p">}</span>
              <span class="p">]</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
</code></pre></div><p>从返回结果中可以看到，其实相关性计算的分数是	rock 和 climbing 两个词语的相关性分数相加而成：</p>
<p>$$
score = score(rock) + score(climbing)
$$</p>
<p>而每个词语的分数的计算公式为：
$$
score(word) = boost * idf * tf
$$
其中 <code>boost</code> 在这里先可以理解为常量，重点在于词频 tf (Term Frequency) 和逆文档频率 idf (Inverse Document Frequency)。词频表示在这篇文档中出现的次数，出现次数越多也就更加相关，逆文档频率是指含有这个词的文档的数量的逆，也就是说这个词在所有文档中出现得越频繁，这个词就越不重要。</p>
<p>更加具体的计算公式在 explaination 中也描述得特别清晰：</p>
<p>其中 idf 的计算公式为：</p>
<p>$$
ln(1 + \frac{N - n + 0.5}{n + 0.5})
$$</p>
<ul>
<li>
<p><code>n</code> 为含有该词语文档的个数</p>
</li>
<li>
<p><code>N</code> 为含有这个字段的文档总数（包括曾经被索引过的文档数）</p>
</li>
</ul>
<p>tf 的计算公式为：</p>
<p>$$
\frac{freq}{freq + k1 * (1 - b * \frac{dl}{avg_dl})}
$$</p>
<p>公式中有<code>k1</code>，<code>b</code> 这两个常量，在这里先不用关系它们。变量有 <code>freq</code> 代表词语在文档中出现的频次，<code>avgdl</code> 平均文档长度，以及 <code>dl</code> 当前文档长度。我们可以稍微化简下公式：</p>
<p>$$
\frac{1}{1 + \frac{k1 * (1 - b * \frac{dl}{avg_dl})}{freq}}
$$</p>
<p>那么就能分析到，<code>freq</code> 越大，频次越高，文档也就越相关；<code>dl</code> 越大，值就会更小，文档就更加不相干；<code>avgdl</code> 越大，平局文档长度越长（词越稀有），文档就会越相关。</p>
<h3 id="计算" class="headerLink">
    <a href="#%e8%ae%a1%e7%ae%97" class="header-mark"></a>计算</h3><p>词 rock 在 <code>doc_0</code> 中的相关性计算:</p>
<ul>
<li>score = boost * idf * tf</li>
<li>boost = 2.2</li>
<li>idf = ln(1 + (N - n + 0.5) / (n + 0.5)) = ln 1.6 = 0.47000363
<ul>
<li>n = 2 ：含有该词语文档的个数</li>
<li>N = 3： 含有这个字段的文档总数（包括曾经被索引过的文档数）</li>
</ul>
</li>
<li>tf = freq / (freq + k1 * (1 - b + b * dl / avgdl)) = 0.44386417
<ul>
<li>freq = 1：在文档中出现的次数</li>
<li>k1 * (1 - b + b * dl / avgdl) = dl / avgdl：文档长度变量，文档长度越长，更加相关。
b、k1 都是常参数，dl 是指该文档的字段长度 ，avgdl 指的是平均文档字段长度。</li>
</ul>
</li>
</ul>
<p>词 climbing 在 <code>doc_0</code> 中的相关性计算:</p>
<ul>
<li>
<p>boost = 2.2</p>
</li>
<li>
<p>idf = ln(1 + (N - n + 0.5) / (n + 0.5)) = ln 2.66 = 0.98082924
n = 1 ：含有该词语文档的个数
N = 3： 含有这个字段的文档总数（包括曾经被索引过的文档数）</p>
</li>
<li>
<p>tf = 0.44386417</p>
</li>
</ul>
<p>最终计算出的相关性分 = 2.2 * 0.47000363 * 0.44386417 + 2.2 * 0.98082924 * 0.44386417 = 1.4167401</p>
<h2 id="es-分片如何索引文档" class="headerLink">
    <a href="#es-%e5%88%86%e7%89%87%e5%a6%82%e4%bd%95%e7%b4%a2%e5%bc%95%e6%96%87%e6%a1%a3" class="header-mark"></a>ES 分片如何索引文档</h2><p>一篇文档会被分词分解成一个个词语，生成一个倒排索引，一个倒排索引是一个 Lucene 索引的段，多个段组成一个 Lucene 索引，而一个 Lucene 索引被称之为一个 ElasticSearch 的分片，将多个分片分布式存储形成了 ElasticSearch。</p>
<p><img
        class="lazyload"
        data-src="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210804132530.png"
        data-srcset="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210804132530.png, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210804132530.png 1.5x, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210804132530.png 2x"
        data-sizes="auto"
        alt="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210804132530.png"
        title="Pasted_image_20210804132530.png"></p>
<h3 id="es-倒排索引的特性" class="headerLink">
    <a href="#es-%e5%80%92%e6%8e%92%e7%b4%a2%e5%bc%95%e7%9a%84%e7%89%b9%e6%80%a7" class="header-mark"></a>ES 倒排索引的特性</h3><p>ES 的倒排索引在写入磁盘是 <code>保持不变的</code>，这样优势是：</p>
<ul>
<li>不需要锁</li>
<li>因为不变性，内核不需要再读取磁盘，直接缓存到内存中请求内存。</li>
<li>对于某个索引 filter 缓存将会一直有效
缺点是因为不可变，新加入一个文档都需要重建索引，索引的数据量大小和更新频率可能只能选择其一。</li>
</ul>
<p>为了保持不变性，可以增加新的索引反馈最近的修改，并且使得每个索引都会被查询到，在每一个分片上查询完结果后合并。</p>
<h3 id="索引更新流程" class="headerLink">
    <a href="#%e7%b4%a2%e5%bc%95%e6%9b%b4%e6%96%b0%e6%b5%81%e7%a8%8b" class="header-mark"></a>索引更新流程</h3><p>1、新的文档被追加到内存索引缓存中，内存索引缓存会不时地提交到磁盘，此时在内存中，还不可见。</p>
<p>2、缓存被提交的时候，会提交一个新的段（一个新的倒排索引）和一个带有新段名字的提交点到磁盘。</p>
<p>3、被提交到磁盘的新段被读取打开，里面包含的文档可以被搜索。</p>
<p>4、内存缓存被清空，准备接受新的文档。</p>
<h3 id="实时搜索的保证" class="headerLink">
    <a href="#%e5%ae%9e%e6%97%b6%e6%90%9c%e7%b4%a2%e7%9a%84%e4%bf%9d%e8%af%81" class="header-mark"></a>实时搜索的保证</h3><p>因为按段搜索（多个倒排索引）的存在，一个新的文档从索引到可被搜索（按段写入磁盘）的延迟降低了，但是可能还需要几分钟，因为按段搜索需要调用 fsync 创建一个提交点。但是 <code>fsync</code> 操作代价很大; 如果每次索引一个文档都去执行一次的话会造成很大的性能问题。更加轻量的方式是走 refresh API。</p>
<p>refresh 是一种轻量级的刷新，通过 refresh 可以不通过 fsync 就让文档被索引到，因为 refresh 通过 write 的系统调用，将内存中的数据转换成文件系统的页缓存，数据能够被很快的写入（还是在内存中），并且能被 read 系统调用作为文件打开。</p>
<p>下面的API，可以通过设置刷新时间把内存刷新的间隔拉长，默认是1s，如果设置成 -1 那么就是不刷新。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">POST /_refresh # 所有索引都刷新
POST /blogs/_refresh # 单个索引刷新
PUT my_logs
{
  &#34;settings&#34;: {
    &#34;refresh_interval&#34;: &#34;60s&#34;
  }
}
</code></pre></div><p>在被刷入磁盘前,内存中新数据是不能被刷新的，例如：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">POST my_logs/_doc
{
  &#34;abc&#34; : 1
}
GET my_logs/_search
</code></pre></div><p>在search API中是60s内看不到新post的数据的。</p>
<h3 id="文件系统页缓存" class="headerLink">
    <a href="#%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f%e9%a1%b5%e7%bc%93%e5%ad%98" class="header-mark"></a>文件系统页缓存</h3><p>页缓存（Page Cache）是位于内存和文件之间的缓冲区，它实际上也是一块内存区域。页缓存对应文件中的一块区域，如果页缓存和对应的文件区域内容不一致，则该页缓存叫做脏页（Dirty Page）。</p>
<p>页缓存查看：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">SZKSGD00582</span>  <span class="o">:</span> <span class="o">~</span>   <span class="o">-&gt;</span> <span class="n">free</span> <span class="o">-</span><span class="n">h</span>
              <span class="n">total</span>        <span class="n">used</span>        <span class="n">free</span>      <span class="n">shared</span>  <span class="n">buff</span><span class="o">/</span><span class="n">cache</span>   <span class="n">available</span>
<span class="n">Mem</span><span class="o">:</span>            <span class="m">23</span><span class="n">G</span>        <span class="m">538</span><span class="n">M</span>         <span class="m">22</span><span class="n">G</span>        <span class="m">401</span><span class="n">M</span>        <span class="m">897</span><span class="n">M</span>         <span class="m">22</span><span class="n">G</span>
<span class="n">Swap</span><span class="o">:</span>            <span class="m">0</span><span class="n">B</span>          <span class="m">0</span><span class="n">B</span>          <span class="m">0</span><span class="n">B</span>
</code></pre></div><p>或者：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">SZKSGD00582</span>  <span class="o">:</span> <span class="o">~</span>   <span class="o">-&gt;</span> <span class="n">cat</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">meminfo</span>
<span class="n">MemTotal</span><span class="o">:</span>       <span class="m">24629088</span> <span class="n">kB</span>
<span class="n">MemFree</span><span class="o">:</span>        <span class="m">23157836</span> <span class="n">kB</span>
<span class="n">MemAvailable</span><span class="o">:</span>   <span class="m">23353692</span> <span class="n">kB</span>
<span class="n">Buffers</span><span class="o">:</span>           <span class="m">20724</span> <span class="n">kB</span>
<span class="o">-&gt;</span> <span class="n">Cached</span><span class="o">:</span>           <span class="m">875168</span> <span class="n">kB</span>
<span class="n">SwapCached</span><span class="o">:</span>            <span class="m">0</span> <span class="n">kB</span>
<span class="n">Active</span><span class="o">:</span>           <span class="m">538556</span> <span class="n">kB</span>
<span class="n">Inactive</span><span class="o">:</span>         <span class="m">807752</span> <span class="n">kB</span>
<span class="nf">Active</span><span class="p">(</span><span class="n">anon</span><span class="p">)</span><span class="o">:</span>     <span class="m">464264</span> <span class="n">kB</span>
<span class="nf">Inactive</span><span class="p">(</span><span class="n">anon</span><span class="p">)</span><span class="o">:</span>   <span class="m">393480</span> <span class="n">kB</span>
<span class="nf">Active</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">:</span>      <span class="m">74292</span> <span class="n">kB</span>
<span class="nf">Inactive</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">:</span>   <span class="m">414272</span> <span class="n">kB</span>
<span class="n">Unevictable</span><span class="o">:</span>           <span class="m">0</span> <span class="n">kB</span>
<span class="n">Mlocked</span><span class="o">:</span>               <span class="m">0</span> <span class="n">kB</span>
<span class="n">SwapTotal</span><span class="o">:</span>             <span class="m">0</span> <span class="n">kB</span>
<span class="n">SwapFree</span><span class="o">:</span>              <span class="m">0</span> <span class="n">kB</span>
<span class="o">-&gt;</span> <span class="n">Dirty</span><span class="o">:</span>                 <span class="m">0</span> <span class="n">kB</span>
<span class="n">Writeback</span><span class="o">:</span>             <span class="m">0</span> <span class="n">kB</span>
<span class="n">AnonPages</span><span class="o">:</span>        <span class="m">407528</span> <span class="n">kB</span>
<span class="n">Mapped</span><span class="o">:</span>           <span class="m">185108</span> <span class="n">kB</span>
<span class="n">Shmem</span><span class="o">:</span>            <span class="m">411116</span> <span class="n">kB</span>
<span class="n">Slab</span><span class="o">:</span>              <span class="m">58664</span> <span class="n">kB</span>
<span class="n">SReclaimable</span><span class="o">:</span>      <span class="m">23568</span> <span class="n">kB</span>
<span class="n">SUnreclaim</span><span class="o">:</span>        <span class="m">35096</span> <span class="n">kB</span>
<span class="n">KernelStack</span><span class="o">:</span>        <span class="m">7648</span> <span class="n">kB</span>
<span class="n">PageTables</span><span class="o">:</span>         <span class="m">3396</span> <span class="n">kB</span>
<span class="n">NFS_Unstable</span><span class="o">:</span>          <span class="m">0</span> <span class="n">kB</span>
<span class="n">Bounce</span><span class="o">:</span>                <span class="m">0</span> <span class="n">kB</span>
<span class="n">WritebackTmp</span><span class="o">:</span>          <span class="m">0</span> <span class="n">kB</span>
<span class="n">CommitLimit</span><span class="o">:</span>    <span class="m">12314544</span> <span class="n">kB</span>
<span class="n">Committed_AS</span><span class="o">:</span>    <span class="m">3829504</span> <span class="n">kB</span>
<span class="n">VmallocTotal</span><span class="o">:</span>   <span class="m">34359738367</span> <span class="n">kB</span>
<span class="n">VmallocUsed</span><span class="o">:</span>           <span class="m">0</span> <span class="n">kB</span>
<span class="n">VmallocChunk</span><span class="o">:</span>          <span class="m">0</span> <span class="n">kB</span>
<span class="n">Percpu</span><span class="o">:</span>             <span class="m">1776</span> <span class="n">kB</span>
<span class="n">AnonHugePages</span><span class="o">:</span>    <span class="m">190464</span> <span class="n">kB</span>
<span class="n">ShmemHugePages</span><span class="o">:</span>        <span class="m">0</span> <span class="n">kB</span>
<span class="n">ShmemPmdMapped</span><span class="o">:</span>        <span class="m">0</span> <span class="n">kB</span>
<span class="n">HugePages_Total</span><span class="o">:</span>       <span class="m">0</span>
<span class="n">HugePages_Free</span><span class="o">:</span>        <span class="m">0</span>
<span class="n">HugePages_Rsvd</span><span class="o">:</span>        <span class="m">0</span>
<span class="n">HugePages_Surp</span><span class="o">:</span>        <span class="m">0</span>
<span class="n">Hugepagesize</span><span class="o">:</span>       <span class="m">2048</span> <span class="n">kB</span>
<span class="n">Hugetlb</span><span class="o">:</span>               <span class="m">0</span> <span class="n">kB</span>
<span class="n">DirectMap4k</span><span class="o">:</span>       <span class="m">15360</span> <span class="n">kB</span>
<span class="n">DirectMap2M</span><span class="o">:</span>     <span class="m">3129344</span> <span class="n">kB</span>
<span class="n">DirectMap1G</span><span class="o">:</span>    <span class="m">23068672</span> <span class="n">kB</span>
</code></pre></div><p>write 系统调用：</p>
<ol>
<li>用户发起write操作</li>
<li>操作系统查找页缓存</li>
<li>若未命中，则产生缺页异常，然后创建页缓存，将用户传入的内容写入页缓存</li>
<li>若命中，则直接将用户传入的内容写入页缓存</li>
<li>用户write调用完成</li>
<li>页被修改后成为脏页，操作系统有两种机制将脏页写回磁盘
<ul>
<li>用户手动调用fsync()</li>
<li>由pdflush进程定时将脏页写回磁盘（脏页数据比例过高，脏页缓存占用的内存太多，长时间未刷新）</li>
</ul>
</li>
</ol>
<p>read 系统调用：</p>
<ol>
<li>用户发起read操作</li>
<li>操作系统查找页缓存</li>
<li>若未命中，则产生缺页异常，然后创建页缓存，并从磁盘读取相应页填充页缓存</li>
<li>若命中，则直接从页缓存返回要读取的内容</li>
<li>用户read调用完成</li>
</ol>
<h3 id="实时删除" class="headerLink">
    <a href="#%e5%ae%9e%e6%97%b6%e5%88%a0%e9%99%a4" class="header-mark"></a>实时删除</h3><p>删除操作：每个提交点会包含一个.del文件，包含被删除的文档，被删除的任然可以被搜索到。</p>
<p>更新操作: 旧文档被标记为删除，新版本文档被索引到一个新的段中</p>
<h3 id="持久化" class="headerLink">
    <a href="#%e6%8c%81%e4%b9%85%e5%8c%96" class="header-mark"></a>持久化</h3><p>虽然通过每秒刷新（refresh）实现了近实时搜索，但是refresh只是写入页缓存，并没有真正写入到磁盘中，我们仍然需要经常进行完整提交来确保能从失败中恢复。es提供了translog（事务日志）机制用于记录操作。类似于redis的aof。</p>
<p>1、一篇文档被索引后会被写入内存缓冲区，并追加到translog。（数据内存中）</p>
<p><img
        class="lazyload"
        data-src="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210810131414.png"
        data-srcset="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210810131414.png, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210810131414.png 1.5x, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210810131414.png 2x"
        data-sizes="auto"
        alt="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210810131414.png"
        title="this&amp;rsquo;s an img"></p>
<p>2、内存缓冲区的数据被写入到一个新段，但是没有fsync，但是可以被用于搜索。（文件系统缓存，仍旧在内存中）</p>
<p><img
        class="lazyload"
        data-src="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210810131726.png"
        data-srcset="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210810131726.png, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210810131726.png 1.5x, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210810131726.png 2x"
        data-sizes="auto"
        alt="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210810131726.png"
        title="this&amp;rsquo;s an img"></p>
<p>3、数据不断积累，执行索引刷新（flush），新的 translog 创建，执行全量提交，内存中的数据写入新段，缓冲区清空，通过fsync将提交点写入硬盘，删除老的translog。</p>
<blockquote>
<p>translog 提供所有还没有被刷到磁盘的操作的一个持久化纪录。当 Elasticsearch 启动的时候， 它会从磁盘中使用最后一个提交点去恢复已知的段，并且会重放 translog 中所有在最后一次提交后发生的变更操作。</p>
</blockquote>
<blockquote>
<p>translog 也被用来提供实时 CRUD 。当你试着通过ID查询、更新、删除一个文档，它会在尝试从相应的段中检索之前， 首先检查 translog 任何最近的变更。这意味着它总是能够实时地获取到文档的最新版本。</p>
</blockquote>
<p><img
        class="lazyload"
        data-src="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210810132149.png"
        data-srcset="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210810132149.png, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210810132149.png 1.5x, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210810132149.png 2x"
        data-sizes="auto"
        alt="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210810132149.png"
        title="this&amp;rsquo;s an img">
<img
        class="lazyload"
        data-src="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210810132712.png"
        data-srcset="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210810132712.png, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210810132712.png 1.5x, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210810132712.png 2x"
        data-sizes="auto"
        alt="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210810132712.png"
        title="this&amp;rsquo;s an img"></p>
<p>flush API 可以用于手动刷新数据，将页缓存刷入磁盘中去。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="err">POST</span> <span class="err">/blogs/_flush</span>    <span class="err">#</span> <span class="err">刷新（flush）blogs</span> <span class="err">索引</span>
<span class="err">POST</span> <span class="err">/_flush?wait_for_ongoing</span> <span class="err">#</span> <span class="err">刷新（flush）所有的索引并且并且等待所有刷新在返回前完成。</span>
</code></pre></div><p>持久化也能通过索引的配置来刷新：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="err">PUT</span> <span class="err">/my_index/_settings</span>
<span class="p">{</span>
    <span class="nt">&#34;index.translog.durability&#34;</span><span class="p">:</span> <span class="s2">&#34;async&#34;</span><span class="p">,</span> <span class="err">#</span> <span class="err">异步刷入磁盘，同步为</span> <span class="nt">&#34;request&#34;</span>
    <span class="s2">&#34;index.translog.sync_interval&#34;</span><span class="p">:</span> <span class="s2">&#34;5s&#34;</span>  <span class="err">#</span> <span class="err">同步磁盘的间隔</span>
<span class="p">}</span>
</code></pre></div><p>translog 默认5s刷一次，或者在每次写请求完成之后执行(e.g. index, delete, update, bulk)，因为数据结构简单+顺序写速度较快。整个请求被 <code>fsync</code> 到主分片和复制分片的translog之前，你的客户端不会得到一个 200 OK 响应。当然如果希望获得更高的吞吐，并且在同步间隔丢失的数据无所谓，那么可以设置为 async，当请求。</p>
<h3 id="段合并" class="headerLink">
    <a href="#%e6%ae%b5%e5%90%88%e5%b9%b6" class="header-mark"></a>段合并</h3><p>每次refesh都会产生一个段，但每秒刷新很快就会导致段数量太多的问题，从而消耗很多cpu、内存、文件句柄，而搜索请求会查询每一个段，所以段数量越多，搜索数量越多。（就像一个哈希表被拆分成多个哈希表，时间复杂度从O(1)转变成O(n)）</p>
<p>段合并在进行索引和搜索时会自动进行：</p>
<ol>
<li>索引文档时，refresh 创建新段用于搜索</li>
<li>合并进程选择大小相似的段在后台合并成大段，不影响索引和搜索</li>
<li>新大段被写入磁盘（flush），另外新的小段也被flush到磁盘，新的提交点被创建，translog也会被清空。</li>
<li>新段可以被打开搜索</li>
<li>老段被删除</li>
</ol>
<p><img
        class="lazyload"
        data-src="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210811132719.png"
        data-srcset="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210811132719.png, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210811132719.png 1.5x, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210811132719.png 2x"
        data-sizes="auto"
        alt="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210811132719.png"
        title="this&amp;rsquo;s an img">
<img
        class="lazyload"
        data-src="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210811132727.png"
        data-srcset="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210811132727.png, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210811132727.png 1.5x, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210811132727.png 2x"
        data-sizes="auto"
        alt="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210811132727.png"
        title="this&amp;rsquo;s an img"></p>
<p>强制合并API：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="err">POST</span> <span class="err">/logstash</span><span class="mi">-2014-10</span><span class="err">/_optimize?max_num_segments=</span><span class="mi">1</span>
</code></pre></div><p>合并大的段需要消耗大量的I/O和CPU资源，如果任其发展会影响搜索性能。Elasticsearch在默认情况下会对合并流程进行资源限制，所以搜索仍然 有足够的资源很好地执行。</p>
<h3 id="总结" class="headerLink">
    <a href="#%e6%80%bb%e7%bb%93" class="header-mark"></a>总结</h3><p><img
        class="lazyload"
        data-src="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210825132839.png"
        data-srcset="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210825132839.png, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210825132839.png 1.5x, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210825132839.png 2x"
        data-sizes="auto"
        alt="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210825132839.png"
        title="this&amp;rsquo;s an img"></p>
<p>es 的索引写入分成两个部分：</p>
<ol>
<li>为了内存使得文档能够被快速被搜索，首先被缓存在内存中，再通过 refresh 使得文档可以被及时搜索到，再周期性地写入磁盘提交。</li>
<li>为了保证文档不丢失，translog能够在内存失效的情况下，从磁盘恢复数据。</li>
</ol>
<h2 id="分布式检索" class="headerLink">
    <a href="#%e5%88%86%e5%b8%83%e5%bc%8f%e6%a3%80%e7%b4%a2" class="header-mark"></a>分布式检索</h2><h2 id="单结点es集群" class="headerLink">
    <a href="#%e5%8d%95%e7%bb%93%e7%82%b9es%e9%9b%86%e7%be%a4" class="header-mark"></a>单结点es集群</h2><p>在创建索引时，可以在setting字段中加入分片设置，下面的配置创建了3个主分片和一份副本，即每个主分片一个副本。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">PUT /blogs
{
   &#34;settings&#34; : {
      &#34;number_of_shards&#34; : 3,
      &#34;number_of_replicas&#34; : 1
   }
}
</code></pre></div><p>当集群中只有一个节点时，状态为：</p>
<p><img
        class="lazyload"
        data-src="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210819190821.png"
        data-srcset="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210819190821.png, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210819190821.png 1.5x, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210819190821.png 2x"
        data-sizes="auto"
        alt="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210819190821.png"
        title="there is an img"></p>
<p>但是可以看到，<code>NODE1</code> 上只有主分片，没有副本分片，因为在同一个节点上既保存原始数据又保存副本是没有意义的。</p>
<p>通过 <code>_health</code> 接口查询，</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">GET /_cluster/health
</code></pre></div><p>其中 status 的值和对应的解释如：</p>
<p>green：所有的主分片和副本分片都正常运行。
yellow：所有的主分片都正常运行，但不是所有的副本分片都正常运行。
red：有主分片没能正常运行。</p>
<p>可以发现此时的集群状态为 <code>yellow</code> ，是因为此时没有副本分片。</p>
<h3 id="多节点集群" class="headerLink">
    <a href="#%e5%a4%9a%e8%8a%82%e7%82%b9%e9%9b%86%e7%be%a4" class="header-mark"></a>多节点集群</h3><p>当加入新物理节点后，es集群就会在新节点上创建副本节点，此时集群状态就会转变为<code>green</code>，因为所有主副分片都正常运行了。</p>
<p><img
        class="lazyload"
        data-src="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210819191400.png"
        data-srcset="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210819191400.png, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210819191400.png 1.5x, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210819191400.png 2x"
        data-sizes="auto"
        alt="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210819191400.png"
        title="there is an img"></p>
<h3 id="多节点负载" class="headerLink">
    <a href="#%e5%a4%9a%e8%8a%82%e7%82%b9%e8%b4%9f%e8%bd%bd" class="header-mark"></a>多节点负载</h3><p>当拥有三个节点后，es 会为了分散负载而对分片进行重新分配，分片数据，如：</p>
<p><img
        class="lazyload"
        data-src="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210819193032.png"
        data-srcset="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210819193032.png, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210819193032.png 1.5x, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210819193032.png 2x"
        data-sizes="auto"
        alt="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210819193032.png"
        title="there is an img"></p>
<p>每一个分片都是一个独立的功能完整的搜索引擎，拥有使用一个节点上的所有资源的能力。</p>
<h3 id="继续扩容" class="headerLink">
    <a href="#%e7%bb%a7%e7%bb%ad%e6%89%a9%e5%ae%b9" class="header-mark"></a>继续扩容</h3><p>es 的主分片数量在创建索引的时候，主分片数量就确定了，之后不可以修改，能修改的只有副本节点。</p>
<p>主分片的数目定义了这个索引能够 存储 的最大数据量。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">
PUT /blogs/_settings
{
   &#34;number_of_replicas&#34; : 2
}
</code></pre></div><p><img
        class="lazyload"
        data-src="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210819200815.png"
        data-srcset="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210819200815.png, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210819200815.png 1.5x, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210819200815.png 2x"
        data-sizes="auto"
        alt="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210819200815.png"
        title="there is an img"></p>
<p>原本3主3副个节点就会扩充到3主6副个节点，这样即使两个节点宕机，也不会丢失数据。其次，有多个副本节点能够获得更高的吞吐，因为在不同的节点上都能处理相同分片的请求了，当然副本节点的数量提升的吞吐取决于机器性能，分片越多，从机器获取的资源也就更少。</p>
<h3 id="集群搜索流程" class="headerLink">
    <a href="#%e9%9b%86%e7%be%a4%e6%90%9c%e7%b4%a2%e6%b5%81%e7%a8%8b" class="header-mark"></a>集群搜索流程</h3><p>我们可以发送请求到集群中的任一节点。 每个节点都有能力处理任意请求。 每个节点都知道集群中任一文档位置，所以可以直接将请求转发到需要的节点上。
1、当请求到达一个节点，那么这个节点就会变成协调节点
2、协调节点把搜索请求发送到其他节点的索引分片上搜索数据
3、然后再汇总数据返回给客户端。</p>
<p><img
        class="lazyload"
        data-src="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210818194118.png"
        data-srcset="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210818194118.png, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210818194118.png 1.5x, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210818194118.png 2x"
        data-sizes="auto"
        alt="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210818194118.png"
        title="there is an img"></p>
<p>文档路由的规则比较常见，对文档ID进行hash得到具体分片，es 不能扩容，扩容就会存在节点对应不上的情况。</p>
<h3 id="分页集群搜索流程" class="headerLink">
    <a href="#%e5%88%86%e9%a1%b5%e9%9b%86%e7%be%a4%e6%90%9c%e7%b4%a2%e6%b5%81%e7%a8%8b" class="header-mark"></a>分页集群搜索流程</h3><p>请求如：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">GET /_search
{
    &#34;from&#34;: 90,
    &#34;size&#34;: 10
}
</code></pre></div><p>的查询流程如下：</p>
<p><img
        class="lazyload"
        data-src="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210729132723.png"
        data-srcset="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210729132723.png, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210729132723.png 1.5x, https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210729132723.png 2x"
        data-sizes="auto"
        alt="https://blog-1256435232.cos.ap-shanghai.myqcloud.com/cnblog/Pasted_image_20210729132723.png"
        title="there is an img"></p>
<ol>
<li>客户端发送一个 <code>search</code> 请求到 <code>Node 3</code> ， <code>Node 3</code> 会创建一个大小为 <code>from + size</code> 的空优先队列。</li>
<li><code>Node 3</code> 将查询请求转发到索引的每个主分片或副本分片中。每个分片在本地执行查询并添加结果到大小为 <code>from + size</code> 的本地有序优先队列中。</li>
<li>每个分片返回各自优先队列中所有文档的 ID 和排序值给协调节点，也就是 <code>Node 3</code> ，它合并这些值到自己的优先队列中来产生一个全局排序后的结果列表。</li>
</ol>
<p>PS：搜索请求被发送到某个节点时，这个节点就变成了协调节点</p>
<p>并且：注意是 from + size，而不是 size，因为每个节点的数据不一定是排好序的，当from很大的时候会有<strong>深分页</strong>存在，多个节点需要返回很多数据，协调节点进行排序，所以会占用相当多的CPU/内存/带宽。“深分页” 很少符合人的行为，人的行为一般停留在前几页，深分页一般是爬虫。</p>
<p>获取集群状态：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">GET _cluster/stats?pretty
</code></pre></div><p>获取分片状态：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">GET /_cat/shards/&lt;target&gt;
GET /_cat/shards
</code></pre></div></div>

        <div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2021-07-24</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span><a class="link-to-mardown" href=/elasticsearch-%E6%A3%80%E7%B4%A2%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86/index.md target="_blank" rel="noopener noreferrer">阅读原始文档</a>
                    </span></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/elasticsearch-%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/" class="prev" rel="prev" title="ElasticSearch 基础使用和理解"><i class="fas fa-angle-left fa-fw"></i>ElasticSearch 基础使用和理解</a>
            <a href="/leetcode_dp/" class="next" rel="next" title="Leetcode: dp 专题">Leetcode: dp 专题<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="disqus_thread" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript></div></article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">
                    由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.89.0">Hugo</a> 强力驱动&nbsp;|&nbsp;主题 - <a href="https://github.com/HEIGE-PCloud/DoIt" target="_blank" rel="noopener noreffer" title="DoIt 0.2.13"><i class="far fa-edit fa-fw"></i> DoIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2016 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank" rel="noopener noreferrer">北极乌布</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="回到顶部">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
            <i class="fas fa-comment fa-fw"></i>
        </a>
    </div><div id="cookieconsent-container"></div><div class="assets"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/fuse/fuse.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/tablesort/tablesort.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script type="text/javascript" src="/lib/topbar/topbar.min.js"></script><script type="text/javascript" src="/lib/pjax/pjax.min.js"></script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-LGMCE8D1GT', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-LGMCE8D1GT" async></script><script>
			var _hmt = _hmt || [];
			(function() {
			  var hm = document.createElement("script");
			  hm.src = "https://hm.baidu.com/hm.js?bf07771626af6858dadc890bb335c55a";
			  var s = document.getElementsByTagName("script")[0]; 
			  s.parentNode.insertBefore(hm, s);
			})();
		</script></div>

<div class="pjax-assets"><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":500},"comment":{},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"data":{"desktop-header-typeit":"PokPok的研究日志","mobile-header-typeit":"PokPok的研究日志"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/index.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"没有找到结果","snippetLength":50,"threshold":0.3,"type":"fuse","useExtendedSearch":false},"table":{"sort":true},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="https://fatwaer.disqus.com/embed.js" defer></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/typeit/typeit.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js" defer></script><script type="text/javascript" src="/lib/katex/auto-render.min.js" defer></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js" defer></script><script type="text/javascript" src="/lib/katex/mhchem.min.js" defer></script><script type="text/javascript" src="/js/katex.min.js" defer></script><script type="text/javascript" src="/js/cookieconsent.min.js" defer></script><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/katex/copy-tex.min.css">
        <noscript><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"></noscript></div>
</body>

</html>